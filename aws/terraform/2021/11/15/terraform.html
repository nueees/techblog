<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Terraform | Cho’s Tech blog</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Terraform" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="section1" />
<meta property="og:description" content="section1" />
<link rel="canonical" href="https://nueees.github.io/techblog/aws/terraform/2021/11/15/terraform.html" />
<meta property="og:url" content="https://nueees.github.io/techblog/aws/terraform/2021/11/15/terraform.html" />
<meta property="og:site_name" content="Cho’s Tech blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-11-15T00:00:00-06:00" />
<script type="application/ld+json">
{"datePublished":"2021-11-15T00:00:00-06:00","url":"https://nueees.github.io/techblog/aws/terraform/2021/11/15/terraform.html","@type":"BlogPosting","dateModified":"2021-11-15T00:00:00-06:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://nueees.github.io/techblog/aws/terraform/2021/11/15/terraform.html"},"headline":"Terraform","description":"section1","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/techblog/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://nueees.github.io/techblog/feed.xml" title="Cho's Tech blog" /><link rel="shortcut icon" type="image/x-icon" href="/techblog/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.css" integrity="sha512-h7nl+xz8wgDlNM4NqKEM4F1NkIRS17M9+uJwIGwuo8vGqIl4BhuCKdxjWEINm+xyrUjNCnK5dCrhM0sj+wTIXw==" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.js" integrity="sha512-/CMIhXiDA3m2c9kzRyd97MTb3MC6OVnx4TElQ7fkkoRghwDf6gi41gaT1PwF270W6+J60uTmwgeRpNpJdRV6sg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js" integrity="sha512-Do7uJAaHZm5OLrIv/yN4w0iG1dbu01kzdMNnFfu/mAqgUk6Nniv2JYHcwH+cNwjqgLcqcuBBk+JRvprLVI8azg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha512-0doc9hKxR3PYwso42RD1p5ySZpzzuDiOwMrdCEh2WdJZCjcmFKc/wEnL+z8fBQrnHoiNWbo+3fiGkOYXBdQp4A==" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/techblog/">Cho&#39;s Tech blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/techblog/about/">About Me</a><a class="page-link" href="/techblog/gitInfo/">gitInfo</a><a class="page-link" href="/techblog/search/">Search</a><a class="page-link" href="/techblog/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Terraform</h1><p class="page-description">section1</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2021-11-15T00:00:00-06:00" itemprop="datePublished">
        Nov 15, 2021
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      15 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/techblog/categories/#aws">aws</a>
        &nbsp;
      
        <a class="category-tags-link" href="/techblog/categories/#terraform">terraform</a>
        
      
      </p>
    

    </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul class="section-nav">
<li class="toc-entry toc-h1"><a href="#1-devops">1. DevOps</a>
<ul>
<li class="toc-entry toc-h2"><a href="#"></a></li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#2-terraform">2. Terraform</a>
<ul>
<li class="toc-entry toc-h2"><a href="#21-구성요소">2.1. 구성요소</a></li>
<li class="toc-entry toc-h2"><a href="#22-작동-원리">2.2. 작동 원리</a>
<ul>
<li class="toc-entry toc-h3"><a href="#form">Form</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#23-구동">2.3. 구동</a>
<ul>
<li class="toc-entry toc-h3"><a href="#provider-생성">provider 생성</a></li>
<li class="toc-entry toc-h3"><a href="#init">init</a></li>
<li class="toc-entry toc-h3"><a href="#resource-생성">resource 생성</a></li>
<li class="toc-entry toc-h3"><a href="#plan">plan</a></li>
<li class="toc-entry toc-h3"><a href="#apply">apply</a></li>
<li class="toc-entry toc-h3"><a href="#import-준비">import 준비</a></li>
<li class="toc-entry toc-h3"><a href="#실제-import">실제 import</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#-1"></a></li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#3-vpc-resource-생성">3. VPC resource 생성</a>
<ul>
<li class="toc-entry toc-h2"><a href="#31-vpc-configure">3.1. VPC configure</a></li>
<li class="toc-entry toc-h2"><a href="#32-subnet-configure">3.2. Subnet configure</a></li>
<li class="toc-entry toc-h2"><a href="#33-internet-gateway-configure">3.3. Internet Gateway configure</a></li>
<li class="toc-entry toc-h2"><a href="#34-route-table-configure">3.4. Route Table configure</a></li>
<li class="toc-entry toc-h2"><a href="#35-private-subnet-and-nat-configure">3.5. Private Subnet and NAT configure</a>
<ul>
<li class="toc-entry toc-h3"><a href="#36-aws-elastic-ip도-함께-생성">3.6. AWS Elastic IP도 함께 생성</a></li>
<li class="toc-entry toc-h3"><a href="#37-private-서브넷에도-route-table을-생성하여-연결">3.7. Private 서브넷에도 Route Table을 생성하여 연결</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#-2"></a></li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#4-s3-resource-생성">4. S3 resource 생성</a>
<ul>
<li class="toc-entry toc-h2"><a href="#41-s3-configure">4.1. S3 configure</a></li>
<li class="toc-entry toc-h2"><a href="#-3"></a></li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#5-terraform-advancement">5. Terraform Advancement</a>
<ul>
<li class="toc-entry toc-h2"><a href="#-4"></a></li>
</ul>
</li>
</ul><p>Terraform with AWS</p>

<hr>

<h1 id="1-devops">
<a class="anchor" href="#1-devops" aria-hidden="true"><span class="octicon octicon-link"></span></a>1. DevOps</h1>

<h2>
<a class="anchor" href="#" aria-hidden="true"><span class="octicon octicon-link"></span></a><br><br>
</h2>
<h1 id="2-terraform">
<a class="anchor" href="#2-terraform" aria-hidden="true"><span class="octicon octicon-link"></span></a>2. Terraform</h1>

<h2 id="21-구성요소">
<a class="anchor" href="#21-%EA%B5%AC%EC%84%B1%EC%9A%94%EC%86%8C" aria-hidden="true"><span class="octicon octicon-link"></span></a>2.1. 구성요소</h2>
<ul>
  <li>
    <p>resource : 실제로 생성할 인프라 자원<br>
ex) aws_security_group, aws_lb, aws_instance</p>
  </li>
  <li>
    <p>provider : Terraform으로 정의할 Infrastructure Provider<br>
<a href="https://www.terraform.io/docs/providers/index.html">각종 providers</a></p>
  </li>
  <li>
    <p>output : 인프라를 provisioning 한 후에 생성된 자원을 스크립트로 추출<br>
추출한 script는 이후에 remote state에서 활용 가능</p>
  </li>
  <li>
    <p>backend : terraform의 상태를 저장하는 공간(default local)<br>
현재 배포된 최신 상태를 외부에 저장하기 때문에 다른 사람과의 협업이 가능 (S3…등)</p>
  </li>
  <li>
    <p>module : 공통적으로 활용할 수 있는 인프라 코드를 한 곳으로 모아서 정의한 함수<br>
변수만 바꿔서 동일한 리소스를 손쉽게 생성 가능</p>
  </li>
  <li>
    <p>remote state : remote state를 사용하면 VPC, IAM 등과 같은 공용 서비스를 다른 서비스에서 참조 가능, tfstate파일(최신 테라폼 상태정보)이 저장되어 있는 backend 정보를 명시하면, terraform이 해당 backend에서 output 정보들을 가져옴</p>
  </li>
</ul>

<h2 id="22-작동-원리">
<a class="anchor" href="#22-%EC%9E%91%EB%8F%99-%EC%9B%90%EB%A6%AC" aria-hidden="true"><span class="octicon octicon-link"></span></a>2.2. 작동 원리</h2>

<h3 id="form">
<a class="anchor" href="#form" aria-hidden="true"><span class="octicon octicon-link"></span></a>Form</h3>
<ul>
  <li>Local 코드 : 현재 개발자가 작성/수정하고 있는 코드</li>
  <li>AWS 실제 인프라 : 실제로 AWS에 배포되어 있는 인프라</li>
  <li>
    <p>Backend에 저장된 상태 : 가장 최근에 배포한 테라폼 코드(tfstate파일) 형상</p>
  </li>
  <li>
    <p>Terraform init
지정한 backend에 상태 저장을 위한 .tfstate 파일을 생성되고 가장 마지막에 적용한 테라폼 내역이 저장<br>
init 작업을 완료하면, local에는 .tfstate에 정의된 내용을 담은 .terraform 파일이 생성<br>
기존에 다른 개발자가 이미 .tfstate에 인프라를 정의해 놓은 것이 있다면, 다른 개발자는 init작업을 통해서 local에 sync를 맞출 수 O</p>
  </li>
  <li>
    <p>Terraform plan
정의한 코드가 어떤 인프라를 만들게 되는지 미리 예측 결과를 보여줍니다. 단, plan을 한 내용에 에러가 없다고 하더라도, 실제 적용되었을 때는 에러가 발생 가<br>
Plan 명령어는 어떠한 형상에도 변화 X</p>
  </li>
  <li>
    <p>Terraform apply
실제로 인프라를 배포하기 위한 명령어입니다. apply를 완료하면, AWS 상에 실제로 해당 인프라가 생성되고 작업 결과가 backend의 .tfstate 파일에 저장<br>
해당 결과는 local의 .terraform 파일에도 저장</p>
  </li>
  <li>Terraform import
AWS 인프라에 배포된 리소스를 terraform state로 옮겨주는 작업<br>
이는 local의 .terraform에 해당 리소스의 상태 정보를 저장해주는 역할 (절대 코드를 생성해주지 X)<br>
Apply 전까지는 backend에 저장되지 X<br>
Import 이후에 plan을 하면 로컬에 해당 코드가 없기 때문에 리소스가 삭제 또는 변경된다는 결과를 display. 이 결과를 바탕으로 코드를 작성 O</li>
</ul>

<h2 id="23-구동">
<a class="anchor" href="#23-%EA%B5%AC%EB%8F%99" aria-hidden="true"><span class="octicon octicon-link"></span></a>2.3. 구동</h2>

<h3 id="provider-생성">
<a class="anchor" href="#provider-%EC%83%9D%EC%84%B1" aria-hidden="true"><span class="octicon octicon-link"></span></a>provider 생성</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>] cat providers.tf 
provider "aws" { 
	region = "eu-central-1" 
}
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>] cat providers.tf # gcp용
provider "google" {}
</code></pre></div></div>

<h3 id="init">
<a class="anchor" href="#init" aria-hidden="true"><span class="octicon octicon-link"></span></a>init</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>] terraform init
Initializing the backend...
Terraform has been successfully initialized!
</code></pre></div></div>

<h3 id="resource-생성">
<a class="anchor" href="#resource-%EC%83%9D%EC%84%B1" aria-hidden="true"><span class="octicon octicon-link"></span></a>resource 생성</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>] cat s3.tf
resource "aws_s3_bucket" "test" {
	bucket = "terraform220222"
}
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>] cat main.tf # gcp용
variable "instance_name" {}
variable "instance_zone" {}
variable "instance_type" {
  default = "n1-standard-1"
  }
variable "instance_network" {}

resource google_compute_instance "vm_instance" {
  name = "${var.instance_name}"
  #RESOURCE properties go here
  zone         = "${var.instance_zone}"
  machine_type = "${var.instance_type}"
  boot_disk {
    initialize_params {
      image = "debian-cloud/debian-9"
      }
  }
  network_interface {
    network = "${var.instance_network}"
    access_config {
      # Allocate a one-to-one NAT IP to the instance
    }
  }
}
</code></pre></div></div>

<h3 id="plan">
<a class="anchor" href="#plan" aria-hidden="true"><span class="octicon octicon-link"></span></a>plan</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>] terraform plan
Terraform used the selected providers to generate the following execution plan.
Resource actions are indicated with the following symbols:
  + create

Terraform will perform the following actions:

  # aws_s3_bucket.test will be created
  + resource "aws_s3_bucket" "test" {
      + acceleration_status                  = (known after apply)
      + acl                                  = (known after apply)
      + arn                                  = (known after apply)
      + bucket                               = "terraform220222"
      + bucket_domain_name                   = (known after apply)
      + bucket_regional_domain_name          = (known after apply)
      + cors_rule                            = (known after apply)
      + force_destroy                        = false
      + grant                                = (known after apply)
      + hosted_zone_id                       = (known after apply)
      + id                                   = (known after apply)
      + lifecycle_rule                       = (known after apply)
      + logging                              = (known after apply)
      + policy                               = (known after apply)
      + region                               = (known after apply)
      + replication_configuration            = (known after apply)
      + request_payer                        = (known after apply)
      + server_side_encryption_configuration = (known after apply)
      + tags_all                             = (known after apply)
      + versioning                           = (known after apply)
      + website                              = (known after apply)
      + website_domain                       = (known after apply)
      + website_endpoint                     = (known after apply)

      + object_lock_configuration {
          + object_lock_enabled = (known after apply)
          + rule                = (known after apply)
        }
    }

Plan: 1 to add, 0 to change, 0 to destroy.
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>] terraform plan # gcp용
Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:
  + create

Terraform will perform the following actions:

  # google_compute_firewall.mynetwork-allow-http-ssh-rdp-icmp will be created
  + resource "google_compute_firewall" "mynetwork-allow-http-ssh-rdp-icmp" {
      + creation_timestamp = (known after apply)
      + destination_ranges = (known after apply)
      + direction          = (known after apply)
      + enable_logging     = (known after apply)
      + id                 = (known after apply)
      + name               = "mynetwork-allow-http-ssh-rdp-icmp"
      + network            = (known after apply)
      + priority           = 1000
      + project            = (known after apply)
      + self_link          = (known after apply)
      + source_ranges      = [
          + "0.0.0.0/0",
        ]

      + allow {
          + ports    = [
              + "22",
              + "80",
              + "3389",
            ]
          + protocol = "tcp"
        }
      + allow {
          + ports    = []
          + protocol = "icmp"
        }
    }

  # google_compute_network.mynetwork will be created
  + resource "google_compute_network" "mynetwork" {
      + auto_create_subnetworks         = true
      + delete_default_routes_on_create = false
      + gateway_ipv4                    = (known after apply)
      + id                              = (known after apply)
      + mtu                             = (known after apply)
      + name                            = "mynetwork"
      + project                         = (known after apply)
      + routing_mode                    = (known after apply)
      + self_link                       = (known after apply)
    }

  # module.mynet-eu-vm.google_compute_instance.vm_instance will be created
  + resource "google_compute_instance" "vm_instance" {
      + can_ip_forward       = false
      + cpu_platform         = (known after apply)
      + current_status       = (known after apply)
      + deletion_protection  = false
      + guest_accelerator    = (known after apply)
      + id                   = (known after apply)
      + instance_id          = (known after apply)
      + label_fingerprint    = (known after apply)
      + machine_type         = "n1-standard-1"
      + metadata_fingerprint = (known after apply)
      + min_cpu_platform     = (known after apply)
      + name                 = "mynet-eu-vm"
      + project              = (known after apply)
      + self_link            = (known after apply)
      + tags_fingerprint     = (known after apply)
      + zone                 = "europe-west1-d"

      + boot_disk {
          + auto_delete                = true
          + device_name                = (known after apply)
          + disk_encryption_key_sha256 = (known after apply)
          + kms_key_self_link          = (known after apply)
          + mode                       = "READ_WRITE"
          + source                     = (known after apply)

          + initialize_params {
              + image  = "debian-cloud/debian-9"
              + labels = (known after apply)
              + size   = (known after apply)
              + type   = (known after apply)
            }
        }

      + confidential_instance_config {
          + enable_confidential_compute = (known after apply)
        }

      + network_interface {
          + ipv6_access_type   = (known after apply)
          + name               = (known after apply)
          + network            = (known after apply)
          + network_ip         = (known after apply)
          + stack_type         = (known after apply)
          + subnetwork         = (known after apply)
          + subnetwork_project = (known after apply)

          + access_config {
              + nat_ip       = (known after apply)
              + network_tier = (known after apply)
            }
        }

      + reservation_affinity {
          + type = (known after apply)

          + specific_reservation {
              + key    = (known after apply)
              + values = (known after apply)
            }
        }

      + scheduling {
          + automatic_restart   = (known after apply)
          + min_node_cpus       = (known after apply)
          + on_host_maintenance = (known after apply)
          + preemptible         = (known after apply)
          + provisioning_model  = (known after apply)

          + node_affinities {
              + key      = (known after apply)
              + operator = (known after apply)
              + values   = (known after apply)
            }
        }
    }

  # module.mynet-us-vm.google_compute_instance.vm_instance will be created
  + resource "google_compute_instance" "vm_instance" {
      + can_ip_forward       = false
      + cpu_platform         = (known after apply)
      + current_status       = (known after apply)
      + deletion_protection  = false
      + guest_accelerator    = (known after apply)
      + id                   = (known after apply)
      + instance_id          = (known after apply)
      + label_fingerprint    = (known after apply)
      + machine_type         = "n1-standard-1"
      + metadata_fingerprint = (known after apply)
      + min_cpu_platform     = (known after apply)
      + name                 = "mynet-us-vm"
      + project              = (known after apply)
      + self_link            = (known after apply)
      + tags_fingerprint     = (known after apply)
      + zone                 = "us-central1-a"

      + boot_disk {
          + auto_delete                = true
          + device_name                = (known after apply)
          + disk_encryption_key_sha256 = (known after apply)
          + kms_key_self_link          = (known after apply)
          + mode                       = "READ_WRITE"
          + source                     = (known after apply)

          + initialize_params {
              + image  = "debian-cloud/debian-9"
              + labels = (known after apply)
              + size   = (known after apply)
              + type   = (known after apply)
            }
        }

      + confidential_instance_config {
          + enable_confidential_compute = (known after apply)
        }

      + network_interface {
          + ipv6_access_type   = (known after apply)
          + name               = (known after apply)
          + network            = (known after apply)
          + network_ip         = (known after apply)
          + stack_type         = (known after apply)
          + subnetwork         = (known after apply)
          + subnetwork_project = (known after apply)

          + access_config {
              + nat_ip       = (known after apply)
              + network_tier = (known after apply)
            }
        }

      + reservation_affinity {
          + type = (known after apply)

          + specific_reservation {
              + key    = (known after apply)
              + values = (known after apply)
            }
        }

      + scheduling {
          + automatic_restart   = (known after apply)
          + min_node_cpus       = (known after apply)
          + on_host_maintenance = (known after apply)
          + preemptible         = (known after apply)
          + provisioning_model  = (known after apply)

          + node_affinities {
              + key      = (known after apply)
              + operator = (known after apply)
              + values   = (known after apply)
            }
        }
    }

Plan: 4 to add, 0 to change, 0 to destroy.
</code></pre></div></div>

<h3 id="apply">
<a class="anchor" href="#apply" aria-hidden="true"><span class="octicon octicon-link"></span></a>apply</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>] terraform apply

Terraform used the selected providers to generate the following execution plan.
Resource actions are indicated with the following symbols:
  + create

Terraform will perform the following actions:

  # aws_s3_bucket.test will be created
  + resource "aws_s3_bucket" "test" {
      + acceleration_status                  = (known after apply)
      + acl                                  = (known after apply)
      + arn                                  = (known after apply)
      + bucket                               = "terraform220222"
      + bucket_domain_name                   = (known after apply)
      + bucket_regional_domain_name          = (known after apply)
      + cors_rule                            = (known after apply)
      + force_destroy                        = false
      + grant                                = (known after apply)
      + hosted_zone_id                       = (known after apply)
      + id                                   = (known after apply)
      + lifecycle_rule                       = (known after apply)
      + logging                              = (known after apply)
      + policy                               = (known after apply)
      + region                               = (known after apply)
      + replication_configuration            = (known after apply)
      + request_payer                        = (known after apply)
      + server_side_encryption_configuration = (known after apply)
      + tags_all                             = (known after apply)
      + versioning                           = (known after apply)
      + website                              = (known after apply)
      + website_domain                       = (known after apply)
      + website_endpoint                     = (known after apply)

      + object_lock_configuration {
          + object_lock_enabled = (known after apply)
          + rule                = (known after apply)
        }
    }

Plan: 1 to add, 0 to change, 0 to destroy.

Do you want to perform these actions?
  Terraform will perform the actions described above.
  Only 'yes' will be accepted to approve.
Enter a value: yes
aws_s3_bucket.test: Creating...
aws_s3_bucket.test: Creation complete after 3s [id=terraform220222]

Apply complete! Resources: 1 added, 0 changed, 0 destroyed.
</code></pre></div></div>

<p>terraform.tfstate 파일이 생성된 거 확인 가능</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>] aws s3 ls  # s3 생성된 거 확인
2022-02-22 16:22:24 terraform220222
</code></pre></div></div>

<h3 id="import-준비">
<a class="anchor" href="#import-%EC%A4%80%EB%B9%84" aria-hidden="true"><span class="octicon octicon-link"></span></a>import 준비</h3>

<p>이전에 먼저 만든 s3 리소스 tf 파일(s3.tf) 날리고 시작</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>] rm s3.tf
] terraform plan
aws_s3_bucket.test: Refreshing state... [id=terraform220222]

Note: Objects have changed outside of Terraform

Terraform detected the following changes made outside of Terraform since the
last "terraform apply":

  # aws_s3_bucket.test has changed
  ~ resource "aws_s3_bucket" "test" {
        id                                   = "terraform220222"
      + tags                                 = {}
        # (18 unchanged attributes hidden)
    }


Unless you have made equivalent changes to your configuration, or ignored the
relevant attributes using ignore_changes, the following plan may include
actions to undo or respond to these changes.

───────────────────────────────────────────────────────────────────────────────

Terraform used the selected providers to generate the following execution plan.
Resource actions are indicated with the following symbols:
  - destroy # 삭제된거 확인

Terraform will perform the following actions:

  # aws_s3_bucket.test will be destroyed # s3 삭제할거라 함
  # (because aws_s3_bucket.test is not in configuration)
  - resource "aws_s3_bucket" "test" {
      - acl                                  = "private" -&gt; null
      - arn                                  = "arn:aws:s3:::terraform220222" -&gt; null
      - bucket                               = "terraform220222" -&gt; null
      - bucket_domain_name                   = "terraform220222.s3.amazonaws.com" -&gt; null
      - bucket_regional_domain_name          = "terraform220222.s3.eu-central-1.amazonaws.com" -&gt; null
      - cors_rule                            = [] -&gt; null
      - force_destroy                        = false -&gt; null
      - grant                                = [] -&gt; null
      - hosted_zone_id                       = "Z21DNDUVLTQW6Q" -&gt; null
      - id                                   = "terraform220222" -&gt; null
      - lifecycle_rule                       = [] -&gt; null
      - logging                              = [] -&gt; null
      - region                               = "eu-central-1" -&gt; null
      - replication_configuration            = [] -&gt; null
      - request_payer                        = "BucketOwner" -&gt; null
      - server_side_encryption_configuration = [] -&gt; null
      - tags                                 = {} -&gt; null
      - tags_all                             = {} -&gt; null
      - versioning                           = [
          - {
              - enabled    = false
              - mfa_delete = false
            },
        ] -&gt; null
      - website                              = [] -&gt; null
    }

Plan: 0 to add, 0 to change, 1 to destroy.
</code></pre></div></div>
<p>state상으로는 s3가 남아있으나 실제는 destroy되었기 때문에,<br>
Objects have changed라는 메시지와 함께 삭제할거라 함</p>

<p>state파일도 지우고 terraform init 상태로 만들어서 plan 확인</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>] rm -f terraform.tfstate
] terraform init
] terraform plan
No changes. Your infrastructure matches the configuration.
Terraform has compared your real infrastructure against your configuration and
found no differences, so no changes are needed.
</code></pre></div></div>
<p>아무것도 안만들어진 상태로 나옴</p>

<p>여기서 부터 기존 리소스 import 시작</p>

<h3 id="실제-import">
<a class="anchor" href="#%EC%8B%A4%EC%A0%9C-import" aria-hidden="true"><span class="octicon octicon-link"></span></a>실제 import</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>] terraform import aws_s3_bucket.test terraform220222 # 코드 공식문서 참조
Error: resource address "aws_s3_bucket.test" does not exist in the configuration.

Before importing this resource, please create its configuration in the root module. For example:
resource "aws_s3_bucket" "test" {
  # (resource arguments)
}
</code></pre></div></div>

<p>위에 에러 가이드 대로, resource 파일(s3.tf) 재생성 후 import</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>] terraform import aws_s3_bucket.test terraform220222 # 다시 import
aws_s3_bucket.test: Importing from ID "terraform220222"...
aws_s3_bucket.test: Import prepared!
  Prepared aws_s3_bucket for import
aws_s3_bucket.test: Refreshing state... [id=terraform220222]

Import successful!

The resources that were imported are shown above. These resources are now in
your Terraform state and will henceforth be managed by Terraform.
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>]  terraform plan
aws_s3_bucket.test: Refreshing state... [id=terraform220222]
No changes. Your infrastructure matches the configuration.

] terraform apply
aws_s3_bucket.test: Refreshing state... [id=terraform220222]
No changes. Your infrastructure matches the configuration.
Terraform has compared your real infrastructure against your configuration and
found no differences, so no changes are needed.
Apply complete! Resources: 0 added, 0 changed, 0 destroyed.

] terraform state list
aws_s3_bucket.test
</code></pre></div></div>

<h2 id="-1">
<a class="anchor" href="#-1" aria-hidden="true"><span class="octicon octicon-link"></span></a><br><br>
</h2>
<h1 id="3-vpc-resource-생성">
<a class="anchor" href="#3-vpc-resource-%EC%83%9D%EC%84%B1" aria-hidden="true"><span class="octicon octicon-link"></span></a>3. VPC resource 생성</h1>

<h2 id="31-vpc-configure">
<a class="anchor" href="#31-vpc-configure" aria-hidden="true"><span class="octicon octicon-link"></span></a>3.1. VPC configure</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>] cat vpc_test.tf
provider "aws" {
  region  = "ap-northeast-2"
}

resource "aws_vpc" "main" {
  cidr_block       = "10.0.0.0/16"

  tags = {
    Name = "terraform220222"
  }
}
}
</code></pre></div></div>

<h2 id="32-subnet-configure">
<a class="anchor" href="#32-subnet-configure" aria-hidden="true"><span class="octicon octicon-link"></span></a>3.2. Subnet configure</h2>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>] cat subnet.tf
provider "aws" {
  region  = "ap-northeast-2"
}

resource "aws_vpc" "main" {
  cidr_block       = "10.0.0.0/16"

  tags = {
    Name = "terraform220222"
  }
}

resource "aws_subnet" "first_subnet" {
  vpc_id     = aws_vpc.main.id
  cidr_block = "10.0.1.0/24"

  availability_zone = "ap-northeast-2a"

  tags = {
    Name = "220222subnet-1"
  }
}


resource "aws_subnet" "second_subnet" {
  vpc_id     = aws_vpc.main.id
  cidr_block = "10.0.2.0/24"

  availability_zone = "ap-northeast-2b"

  tags = {
    Name = "220222subnet-2"
  }
}
</code></pre></div></div>

<h2 id="33-internet-gateway-configure">
<a class="anchor" href="#33-internet-gateway-configure" aria-hidden="true"><span class="octicon octicon-link"></span></a>3.3. Internet Gateway configure</h2>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>] cat internet_gateway.tf
resource "aws_internet_gateway" "igw" {
  vpc_id = aws_vpc.main.id

  tags = {
    Name = "main"
  }
}
</code></pre></div></div>

<h2 id="34-route-table-configure">
<a class="anchor" href="#34-route-table-configure" aria-hidden="true"><span class="octicon octicon-link"></span></a>3.4. Route Table configure</h2>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>] cat route_table.tf
resource "aws_route_table" "route_table" {
  vpc_id = aws_vpc.main.id

  tags = {
    Name = "main"
  }
}

resource "aws_route_table_association" "route_table_association_1" {
  subnet_id      = aws_subnet.first_subnet.id
  route_table_id = aws_route_table.route_table.id
}

resource "aws_route_table_association" "route_table_association_2" {
  subnet_id      = aws_subnet.second_subnet.id
  route_table_id = aws_route_table.route_table.id
}
</code></pre></div></div>

<h2 id="35-private-subnet-and-nat-configure">
<a class="anchor" href="#35-private-subnet-and-nat-configure" aria-hidden="true"><span class="octicon octicon-link"></span></a>3.5. Private Subnet and NAT configure</h2>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>] cat private_subnet_nat.tf
resource "aws_subnet" "first_private_subnet" {
  vpc_id     = aws_vpc.main.id
  cidr_block = "10.0.3.0/24"

  availability_zone = "ap-northeast-2a"

  tags = {
    Name = "220222subnet-private-1"
  }
}

resource "aws_subnet" "second_private_subnet" {
  vpc_id     = aws_vpc.main.id
  cidr_block = "10.0.4.0/24"

  availability_zone = "ap-northeast-2b"

  tags = {
    Name = "220222subnet-private-2"
  }
}
</code></pre></div></div>

<h3 id="36-aws-elastic-ip도-함께-생성">
<a class="anchor" href="#36-aws-elastic-ip%EB%8F%84-%ED%95%A8%EA%BB%98-%EC%83%9D%EC%84%B1" aria-hidden="true"><span class="octicon octicon-link"></span></a>3.6. AWS Elastic IP도 함께 생성</h3>
<p>Nat Gateway는 Public 서브넷에 위치하지만 private 서브넷과 연결</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>resource "aws_eip" "nat_1" {
  vpc   = true

  lifecycle {
    create_before_destroy = true
  }
}

resource "aws_eip" "nat_2" {
  vpc   = true

  lifecycle {
    create_before_destroy = true
  }
}

resource "aws_nat_gateway" "nat_gateway_1" {
  allocation_id = aws_eip.nat_1.id

  # Private subnet이 아니라 public subnet을 연결
  subnet_id = aws_subnet.first_subnet.id

  tags = {
    Name = "NAT-GW-1"
  }
}

resource "aws_nat_gateway" "nat_gateway_2" {
  allocation_id = aws_eip.nat_2.id

  subnet_id = aws_subnet.second_subnet.id

  tags = {
    Name = "NAT-GW-2"
  }
}
</code></pre></div></div>

<h3 id="37-private-서브넷에도-route-table을-생성하여-연결">
<a class="anchor" href="#37-private-%EC%84%9C%EB%B8%8C%EB%84%B7%EC%97%90%EB%8F%84-route-table%EC%9D%84-%EC%83%9D%EC%84%B1%ED%95%98%EC%97%AC-%EC%97%B0%EA%B2%B0" aria-hidden="true"><span class="octicon octicon-link"></span></a>3.7. Private 서브넷에도 Route Table을 생성하여 연결</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>resource "aws_route_table" "route_table_private_1" {
  vpc_id = aws_vpc.main.id

  tags = {
    Name = "main-private-1"
  }
}

resource "aws_route_table" "route_table_private_2" {
  vpc_id = aws_vpc.main.id

  tags = {
    Name = "main-private-2"
  }
}

resource "aws_route_table_association" "route_table_association_private_1" {
  subnet_id      = aws_subnet.first_private_subnet.id
  route_table_id = aws_route_table.route_table_private_1.id
}

resource "aws_route_table_association" "route_table_association_private_2" {
  subnet_id      = aws_subnet.second_private_subnet.id
  route_table_id = aws_route_table.route_table_private_2.id
}

resource "aws_route" "private_nat_1" {
  route_table_id              = aws_route_table.route_table_private_1.id
  destination_cidr_block      = "0.0.0.0/0"
  nat_gateway_id              = aws_nat_gateway.nat_gateway_1.id
}

resource "aws_route" "private_nat_2" {
  route_table_id              = aws_route_table.route_table_private_2.id
  destination_cidr_block      = "0.0.0.0/0"
  nat_gateway_id              = aws_nat_gateway.nat_gateway_2.id
}
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>] cat mynetwork.tf # gcp용
# Create the mynetwork network
resource "google_compute_network" "mynetwork" {
  name = "mynetwork"
  #RESOURCE properties go here
  auto_create_subnetworks = "true"
}
# Add a firewall rule to allow HTTP, SSH, RDP and ICMP traffic on mynetwork
resource "google_compute_firewall" "mynetwork-allow-http-ssh-rdp-icmp" {
  name = "mynetwork-allow-http-ssh-rdp-icmp"
  #RESOURCE properties go here
  network = google_compute_network.mynetwork.self_link
  allow {
    protocol = "tcp"
    ports    = ["22", "80", "3389"]
  }
  allow {
    protocol = "icmp"
  }
  source_ranges = ["0.0.0.0/0"]
}
# Create the mynet-us-vm instance
module "mynet-us-vm" {
  source           = "./instance"
  instance_name    = "mynet-us-vm"
  instance_zone    = "us-central1-a"
  instance_network = google_compute_network.mynetwork.self_link
}
# Create the mynet-eu-vm" instance
module "mynet-eu-vm" {
  source           = "./instance"
  instance_name    = "mynet-eu-vm"
  instance_zone    = "europe-west1-d"
  instance_network = google_compute_network.mynetwork.self_link
}
</code></pre></div></div>

<h2 id="-2">
<a class="anchor" href="#-2" aria-hidden="true"><span class="octicon octicon-link"></span></a><br><br>
</h2>
<h1 id="4-s3-resource-생성">
<a class="anchor" href="#4-s3-resource-%EC%83%9D%EC%84%B1" aria-hidden="true"><span class="octicon octicon-link"></span></a>4. S3 resource 생성</h1>

<h2 id="41-s3-configure">
<a class="anchor" href="#41-s3-configure" aria-hidden="true"><span class="octicon octicon-link"></span></a>4.1. S3 configure</h2>

<h2 id="-3">
<a class="anchor" href="#-3" aria-hidden="true"><span class="octicon octicon-link"></span></a><br><br>
</h2>
<h1 id="5-terraform-advancement">
<a class="anchor" href="#5-terraform-advancement" aria-hidden="true"><span class="octicon octicon-link"></span></a>5. Terraform Advancement</h1>

<h2 id="-4">
<a class="anchor" href="#-4" aria-hidden="true"><span class="octicon octicon-link"></span></a><br><br>
</h2>

  </div><a class="u-url" href="/techblog/aws/terraform/2021/11/15/terraform.html" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/techblog/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="https://nueees.github.io/techblog/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/techblog/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>A challenge-loving data engineer.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"></ul>
</div>

  </div>

</footer>
</body>

</html>
