---
toc: false
layout: post
description: Exporter, PromQL, Operator
categories: [helm, kubernetes]
title: Helm
---

[how-to-declaratively-run-helm-charts-using-helmfile](https://medium.com/swlh/how-to-declaratively-run-helm-charts-using-helmfile-ac78572e6088)

---

# 1. Helm
kubernetes의 package manager  
기존 kubectl 명령어로는 여러개의 yaml 파일 생성 관리해야 하는데 helm이 Charts로 묶어서 관리하게 함  

## 1.1. [Helm Install](https://helm.sh/docs/intro/install/)
helm 설치  
```
] brew install helm
```

## 1.2. [Chart Repository](https://helm.sh/docs/topics/chart_repository/) 가져오기
[Bitnami Chart Repository](https://charts.bitnami.com/bitnami) 추가  
```
] helm repo add my-repo https://charts.bitnami.com/bitnami
] kubectl create ns metircs # namespace 생성
```

## 1.3. Repository에서 Chart 가져오기
[kube-state-metrics](https://artifacthub.io/packages/helm/bitnami/kube-state-metrics): Kubernetes API server and objects의 상태값 메트릭으로 생성  
```
] helm install kube-state-metrics my-repo/kube-state-metrics -n metrics # helm chart 추가
] helm ls -n metrics
NAME                    NAMESPACE       REVISION        UPDATED                                 STATUS          CHART                          APP VERSION
kube-state-metrics      metrics         1               2023-02-09 11:53:54.2417933 +0100 CET   deployed        kube-state-metrics-3.2.8       2.7.0

] kubectl get all -n metrics
NAME                                      READY   STATUS    RESTARTS   AGE
pod/kube-state-metrics-647765674c-2gl2n   1/1     Running   0          179m
NAME                         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE
service/kube-state-metrics   ClusterIP   10.111.131.223   <none>        8080/TCP   179m
NAME                                 READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/kube-state-metrics   1/1     1            1           179m
NAME                                            DESIRED   CURRENT   READY   AGE
replicaset.apps/kube-state-metrics-647765674c   1         1         1       179m

] kubectl logs pod/kube-state-metrics-647765674c-2gl2n -n metrics
I0209 10:53:55.686419       1 wrapper.go:78] Starting kube-state-metrics
I0209 10:53:55.686869       1 server.go:138] "Used resources" resources="certificatesigningrequests,configmaps,cronjobs,daemonsets,deployments,endpoints,horizontalpodautoscalers,ingresses,jobs,limitranges,mutatingwebhookconfigurations,namespaces,networkpolicies,nodes,persistentvolumeclaims,persistentvolumes,poddisruptionbudgets,pods,replicasets,replicationcontrollers,resourcequotas,secrets,services,statefulsets,storageclasses,volumeattachments"
I0209 10:53:55.686904       1 types.go:184] "Using all namespaces"
I0209 10:53:55.686924       1 server.go:166] "Metric allow-denylisting" allowDenyStatus="Excluding the following lists that were on denylist: "
W0209 10:53:55.686986       1 client_config.go:617] Neither --kubeconfig nor --master was specified.  Using the inClusterConfig.  This might not work.
I0209 10:53:55.687305       1 server.go:311] "Tested communication with server"
I0209 10:53:55.696886       1 server.go:316] "Run with Kubernetes cluster version" major="1" minor="24" gitVersion="v1.24.0" gitTreeState="clean" gitCommit="4ce5a8954017644c5420bae81d72b09b735c21f0" platform="linux/amd64"
I0209 10:53:55.696909       1 server.go:317] "Communication with server successful"
I0209 10:53:55.697032       1 server.go:263] "Started metrics server" metricsServerAddress="[::]:8080"
I0209 10:53:55.697104       1 metrics_handler.go:97] "Autosharding disabled"
I0209 10:53:55.697132       1 server.go:252] "Started kube-state-metrics self metrics server" telemetryAddress="[::]:8081"
I0209 10:53:55.697252       1 server.go:69] levelinfomsgListening onaddress[::]:8080
I0209 10:53:55.697284       1 server.go:69] levelinfomsgTLS is disabled.http2falseaddress[::]:8080
I0209 10:53:55.697410       1 server.go:69] levelinfomsgListening onaddress[::]:8081
I0209 10:53:55.697440       1 server.go:69] levelinfomsgTLS is disabled.http2falseaddress[::]:8081
I0209 10:53:55.699392       1 builder.go:257] "Active resources" activeStoreNames="certificatesigningrequests,configmaps,cronjobs,daemonsets,deployments,endpoints,horizontalpodautoscalers,ingresses,jobs,limitranges,mutatingwebhookconfigurations,namespaces,networkpolicies,nodes,persistentvolumeclaims,persistentvolumes,poddisruptionbudgets,pods,replicasets,replicationcontrollers,resourcequotas,secrets,services,statefulsets,storageclasses,volumeattachments"

] kubectl port-forward svc/kube-state-metrics 8080:8080 -n metrics # WebUI로 해당 k8s metrics 확인 가능
```



---

# 2. Helm Custumizing

## 2.1. Chart 열어보기
기본적인 chart 정보
```
] helm show chart my-repo/kube-state-metrics
annotations:
  category: Analytics
  licenses: Apache-2.0
apiVersion: v2
appVersion: 2.7.0
dependencies:
- name: common
  repository: https://charts.bitnami.com/bitnami
  tags:
  - bitnami-common
  version: 2.x.x
description: kube-state-metrics is a simple service that listens to the Kubernetes
  API server and generates metrics about the state of the objects.
home: https://github.com/bitnami/charts/tree/main/bitnami/kube-state-metrics
icon: https://bitnami.com/assets/stacks/kube-state-metrics/img/kube-state-metrics-stack-220x234.png
keywords:
- prometheus
- kube-state-metrics
- monitoring
maintainers:
- name: Bitnami
  url: https://github.com/bitnami/charts
name: kube-state-metrics
sources:
- https://github.com/bitnami/containers/tree/main/bitnami/kube-state-metrics
- https://github.com/kubernetes/kube-state-metrics
version: 3.2.8
```

필요한 value정보들
```
] helm show values my-repo/kube-state-metric > values.yaml
image:
  registry: docker.io
  repository: bitnami/kube-state-metrics
  tag: 2.7.0-debian-11-r21
imagePullSecrets: []
nameOverride: ""
fullnameOverride: ""
kubeResources:
  configmaps: true
  cronjobs: true
  daemonsets: true
  deployments: true
  endpoints: true
  ingresses: true
  jobs: true
  namespaces: true
  nodes: true
  persistentvolumeclaims: true
  persistentvolumes: true
  pods: true
  replicasets: true
  replicationcontrollers: true
  secrets: true
  services: true
  statefulsets: true
  storageclasses: true
service:
  type: ClusterIP
  ports:
    http: 8080
  nodePorts:
    http: ""
  clusterIP: ""
...
resources:
  limits: {}
  requests: {}
replicaCount: 1
podAnnotations: {}
nodeSelector: {}
...
livenessProbe:
  enabled: true
  initialDelaySeconds: 120
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 6
  successThreshold: 1
...
```

install 시 set으로 지정가능
```
] helm install kube-state-metrics my-repo/kube-state-metrics -n metrics \
--set kubeResources.cronjobs=false \
--set apiService.create=true 
```


Clean up
```
] helm delete kube-state-metrics
] kubectl delete ns metrics
```



## 2.2. Chart 생성
기본적인 chart 모델로 boilerplate 생성  
```
] helm create first-chart
```
기본 파일(templetes 폴더 내 configmap.yaml 추가) 수정 후 install  
```
] helm install first-chart .
] kubectl get cm
NAME                    DATA   AGE
first-chart-configmap   1      8s
kube-root-ca.crt        1      7h9m
] kubectl describe configmap first-chart-configmap
Name:         first-chart-configmap
Namespace:    default
Labels:       app.kubernetes.io/managed-by=Helm
Annotations:  meta.helm.sh/release-name: first-chart
              meta.helm.sh/release-namespace: default
Data
====
port:
----
8080
BinaryData
```

## 2.3. Chart 수정

```

```

---

# 3. Helmfile로 관리
이제껏 imperative하게 관리하던 것을 declarative하게 관리 가능

## 3.1. Helmfile 만들기


---




